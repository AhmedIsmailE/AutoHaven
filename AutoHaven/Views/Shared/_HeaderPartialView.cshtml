@using AutoHaven.Models
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUserModel> UserManager
@{
    var role = User.FindFirst("Role")?.Value;
}
<header class="sticky top-0 z-50 w-full border-b border-gray-200/50 dark:border-gray-800/50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between whitespace-nowrap h-16">

            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3 text-primary dark:text-white">
                    <div class="size-6">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold tracking-tight"><a href="@Url.Action("Home", "Home")">AutoHaven</a> </h2>
                </div>
                <nav class="hidden md:flex items-center gap-8">
                    @if (!User.Identity.IsAuthenticated)
                    {
                        @* <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" asp-controller="Car" asp-action="Create">Sell</a> *@
                        <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" asp-controller="Home" asp-action="Home">Home</a>
                    }
                    @if (role != "Customer" && User.Identity.IsAuthenticated)
                    {
                        @* <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" asp-controller="Car" asp-action="Create">Sell</a> *@
                        <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" asp-controller="Car" asp-action="Create">Create Listing</a>
                    }

                    @* <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" href="#">Buy</a>
                    <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" href="#">Rent</a> *@
                    <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" asp-controller="Car" asp-action="Index">Browse Cars</a>
                    <a class="text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" asp-controller="Account" asp-action="About">About Us</a>
                </nav>
            </div>

            @{
                var isAuthenticated = User?.Identity?.IsAuthenticated == true;
                string? avatarUrl = null;
                string profileUrl = Url.Action("Profile", "Account");

                if (isAuthenticated)
                {
                    try
                    {
                        // await properly inside the view
                        var appUser = await UserManager.GetUserAsync(User);
                        if (appUser != null)
                        {
                            avatarUrl = appUser.AvatarUrl;

                            // ensure profile link contains current user's id
                            profileUrl = Url.Action("Profile", "Account", new { id = appUser.Id });
                        }
                    }
                    catch
                    {
                        avatarUrl = null;
                    }
                }

                // canonical fallback path (ensure this file exists under wwwroot/images/Default/default.jpg)
                var fallback = "/images/Default/default.jpg";

                // Normalize avatarUrl to absolute app path using Url.Content
                if (!string.IsNullOrWhiteSpace(avatarUrl))
                {
                    // if avatarUrl already looks absolute (starts with http or leading slash), keep it otherwise turn into app-relative path
                    if (avatarUrl.StartsWith("http", StringComparison.OrdinalIgnoreCase) || avatarUrl.StartsWith("/"))
                    {
                        avatarUrl = Url.Content(avatarUrl);
                    }
                    else
                    {
                        // e.g. "images/Default/default.jpg" -> "~/images/Default/default.jpg" -> "/images/Default/default.jpg"
                        avatarUrl = Url.Content("~/" + avatarUrl.TrimStart('~', '/'));
                    }
                }
                else if (isAuthenticated)
                {
                    avatarUrl = Url.Content(fallback);
                }
            }

            <div class="flex flex-1 justify-end items-center gap-4">
                <div class="hidden sm:flex items-center gap-2">
                    @if (isAuthenticated)
                    {
                        <form method="post" asp-controller="Account" asp-action="Logout" class="inline">
                            <button type="submit" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-5 bg-gray-200 dark:bg-gray-800 text-accent dark:text-gray-300 text-sm font-bold hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                                <span class="truncate">Log Out</span>
                            </button>
                        </form>
                    }
                    else
                    {
                        <a href="/Account/Login" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-5 bg-gray-200 dark:bg-gray-800 text-accent dark:text-gray-300 text-sm font-bold hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                            <span class="truncate">Log In</span>
                        </a>
                        <a href="/Account/Register" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-5 bg-gradient-to-br from-primary to-blue-900 text-white text-sm font-bold shadow-sm hover:shadow-lg transition-shadow">
                            <span class="truncate">Sign Up</span>
                        </a>
                    }
                </div>

                @if (isAuthenticated && !string.IsNullOrWhiteSpace(avatarUrl))
                {
                    <a href="@profileUrl" title="View profile" class="ml-2">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 w-10 h-10 border shadow-sm"
                             style="background-image: url('@avatarUrl');"></div>
                    </a>
                }
            </div>
        </div>
    </div>
</header>
