@model IEnumerable<AutoHaven.Models.CarListingModel>
@using AutoHaven.Models

@{
    ViewData["Title"] = "My Favorites";

    // Model is the current page items
    var favorites = Model?.ToList() ?? new List<CarListingModel>();

    // Use the authoritative total (provided by controller)
    var totalCount = (ViewBag.TotalCount as int?) ?? favorites.Count;
    var currentPage = (ViewBag.CurrentPage as int?) ?? 1;
    var totalPages = (ViewBag.TotalPages as int?) ?? 1;
    var pageSize = (ViewBag.PageSize as int?) ?? 12;

    string DefaultImageUrl() => Url.Content("~/images/default-car.png");

    string GetImageUrl(CarListingModel listing)
    {
        var mainImage = listing.CarImages?.FirstOrDefault();
        var path = mainImage?.Path;

        if (string.IsNullOrWhiteSpace(path))
            return DefaultImageUrl();

        if (path.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
            path.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
        {
            return path;
        }

        if (path.StartsWith("Uploads/", StringComparison.OrdinalIgnoreCase) ||
            path.StartsWith("Uploads\\", StringComparison.OrdinalIgnoreCase))
        {
            return Url.Content("~/" + path.Replace("\\", "/"));
        }

        return Url.Content("~/" + path.TrimStart('~', '/').Replace("\\", "/"));
    }

    string GetTitle(CarListingModel listing)
    {
        if (listing.Car != null)
        {
            return $"{listing.Car.ModelYear} {listing.Car.Manufacturer} {listing.Car.Model}";
        }
        return $"Listing #{listing.ListingId}";
    }

    string GetMeta(CarListingModel listing)
    {
        var parts = new List<string>();

        if (listing.Car != null)
        {
            parts.Add(listing.Car.ModelYear.ToString());

            var transmission = listing.Car.CurrentTransmission == CarModel.Transmission.Automatic
                ? "Automatic"
                : "Manual";
            parts.Add(transmission);
        }

        string typeLabel = listing.Type == CarListingModel.ListingType.ForSelling
            ? "For Sale"
            : "For Rent";

        parts.Add(typeLabel);

        return string.Join(" · ", parts);
    }

    (decimal price, string label) GetPrice(CarListingModel listing)
    {
        if (listing.Type == CarListingModel.ListingType.ForSelling)
        {
            return (listing.NewPrice, string.Empty);
        }
        else
        {
            return (listing.RentPrice, "/day");
        }
    }
}

@* anti-forgery token used by JS *@
<form id="antiForgeryForm" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>

<div class="w-full max-w-6xl mx-auto px-4 py-10">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-extrabold tracking-tight text-gray-900">
                Favorites
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                @if (totalCount > 0)
                {
                    <text>You have <span id="favoritesCount">@totalCount</span> saved @(totalCount == 1 ? "car" : "cars") in your favorites.</text>
                }
                else
                {
                    <text>You haven't added any cars to your favorites yet.</text>
                }
            </p>
        </div>

        <!-- Sort dropdown (visual) -->
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-500">Sort by:</span>
            <div class="relative">
                <select id="sortSelect"
                        class="appearance-none text-sm font-medium pl-3 pr-8 py-2 rounded-lg border border-gray-200 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="date_desc">Date Added</option>
                    <option value="price_asc">Price: Low to High</option>
                    <option value="price_desc">Price: High to Low</option>
                </select>
                <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M19 9l-7 7-7-7" />
                    </svg>
                </span>
            </div>
        </div>
    </div>

    @if (ViewBag.Error != null)
    {
        <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
            @ViewBag.Error
        </div>
    }

    @* --- Empty state (always present, hidden when there are favorites) --- *@
    <div id="emptyState" class="w-full mt-10" style="@(totalCount > 0 ? "display:none" : "")">
        <div class="max-w-2xl mx-auto flex flex-col items-center justify-center text-center gap-4 py-8">
            <div class="flex items-center justify-center h-20 w-20 rounded-full bg-gray-100 text-gray-400">
                <span class="material-symbols-outlined text-4xl">favorite</span>
            </div>

            <div>
                <h2 class="text-lg font-semibold text-gray-900 mb-2">No favorites yet</h2>
                <p class="text-sm text-gray-500 max-w-md mx-auto">
                    Browse our listings and tap the heart icon on any car to save it here for quick access.
                </p>
            </div>

            <a href="@Url.Action("Index", "Car")"
               class="mt-3 inline-flex items-center rounded-full bg-blue-600 px-6 py-2 text-sm font-semibold text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                Browse Cars
            </a>
        </div>
    </div>

    @* Favorites Grid (rendered only when there are favorites) *@
    @if (favorites.Any())
    {
        <div id="favoritesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-6">
            @foreach (var listing in favorites)
            {
                var title = GetTitle(listing);
                var meta = GetMeta(listing);
                var (price, priceLabel) = GetPrice(listing);
                var imageUrl = GetImageUrl(listing);
                var updatedAt = listing.UpdatedAt.ToUniversalTime().Ticks;

                <div class="js-favorite-card group relative flex flex-col rounded-2xl bg-white shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-200 border border-gray-100"
                     data-price="@price"
                     data-date="@updatedAt"
                     data-listing-id="@listing.ListingId">
                    <!-- Image -->
                    <div class="relative h-48 w-full overflow-hidden rounded-t-2xl bg-gray-100">
                        <img src="@imageUrl"
                             alt="@title"
                             class="h-full w-full object-cover group-hover:scale-105 transition-transform duration-300" />
                    </div>

                    @* Single button (no full-form post) — JS handles RemoveFromFavorite *@
                    <div class="absolute right-3 top-4">
                        <button type="button"
                                class="js-favorite-toggle inline-flex h-9 w-9 items-center justify-center rounded-full bg-white/90 shadow-md hover:bg-white"
                                aria-pressed="true"
                                data-listing-id="@listing.ListingId"
                                title="Remove from favorites">
                            <span class="material-symbols-outlined text-lg text-red-500">favorite</span>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="flex flex-1 flex-col px-4 pt-4 pb-4">
                        <h3 class="text-base font-semibold text-gray-900 line-clamp-2">@title</h3>

                        @if (!string.IsNullOrWhiteSpace(meta))
                        {
                            <p class="mt-1 text-xs text-gray-500">@meta</p>
                        }

                        <div class="mt-4 flex items-end justify-between gap-2">
                            <div>
                                <p class="text-lg font-extrabold text-gray-900">
                                    $@price.ToString("N0")
                                    @if (!string.IsNullOrEmpty(priceLabel))
                                    {
                                        <span class="text-sm font-medium text-gray-500">@priceLabel</span>
                                    }
                                </p>
                            </div>

                            <a href="@Url.Action("Details", "Car", new { id = listing.ListingId })"
                               class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1 text-xs font-semibold text-gray-700 hover:border-blue-500 hover:text-blue-600">
                                View details
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="mt-8 flex justify-center items-center gap-3">
            <nav class="inline-flex items-center gap-2" aria-label="Pagination">
                <a class="px-3 py-2 rounded-md border border-gray-200 bg-white"
                   asp-action="Favorites" asp-controller="Account"
                   asp-route-page="@(currentPage > 1 ? currentPage - 1 : 1)"
                   asp-route-pageSize="@pageSize">‹</a>

                @for (int i = 1; i <= totalPages; i++)
                {
                    if (i == currentPage)
                    {
                        <span class="px-3 py-2 rounded-md bg-blue-600 text-white">@i</span>
                    }
                    else if (i <= 3 || i > totalPages - 3 || (i >= currentPage - 1 && i <= currentPage + 1))
                    {
                        <a class="px-3 py-2 rounded-md border border-gray-200 bg-white"
                           asp-action="Favorites" asp-controller="Account" asp-route-page="@i" asp-route-pageSize="@pageSize">@i</a>
                    }
                    else if (i == 4 && currentPage > 4)
                    {
                        <span class="px-3 py-2">…</span>
                    }
                }

                <a class="px-3 py-2 rounded-md border border-gray-200 bg-white"
                   asp-action="Favorites" asp-controller="Account"
                   asp-route-page="@(currentPage<totalPages? currentPage + 1 : totalPages)"
                   asp-route-pageSize="@pageSize">›</a>
            </nav>
        </div>
    }

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // small toast helper (SweetAlert2)
        function showToast(type, message) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type || 'info',
                title: message || '',
                showConfirmButton: false,
                timer: 2500,
                timerProgressBar: true
            });
        }

        // Sorting logic (unchanged)
        (function () {
            const sortSelect = document.getElementById('sortSelect');
            const grid = document.getElementById('favoritesGrid');
            if (!sortSelect || !grid) return;

            sortSelect.addEventListener('change', () => {
                const cards = Array.from(grid.querySelectorAll('.js-favorite-card'));
                const value = sortSelect.value;

                cards.sort((a, b) => {
                    const priceA = parseFloat(a.dataset.price || "0");
                    const priceB = parseFloat(b.dataset.price || "0");
                    const dateA = parseInt(a.dataset.date || "0");
                    const dateB = parseInt(b.dataset.date || "0");

                    switch (value) {
                        case 'price_asc':
                            return priceA - priceB;
                        case 'price_desc':
                            return priceB - priceA;
                        case 'date_desc':
                        default:
                            return dateB - dateA;
                    }
                });

                cards.forEach(c => grid.appendChild(c));
            });
        })();

        // --- AJAX remove from favorites (stays on same page) ---
        (function () {
            // Get antiforgery token from hidden input
            function getAntiForgeryToken() {
                var input = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
                return input ? input.value : '';
            }

            function postFormUrlEncoded(url, data) {
                return fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: new URLSearchParams(data),
                    credentials: 'same-origin'
                }).then(async r => {
                    // return both raw response and parsed json (if any)
                    const ret = { ok: r.ok, status: r.status, json: null, text: null };
                    try {
                        ret.json = await r.json();
                    } catch (e) {
                        // not JSON
                        try { ret.text = await r.text(); } catch {}
                    }
                    return ret;
                });
            }

        function updateFavoritesCount(delta) {
            const el = document.getElementById('favoritesCount');
            if (!el) return;
            const current = parseInt(el.textContent || '0', 10);
            const next = Math.max(0, current + delta);
            el.textContent = next;

            // pagination container (server-rendered)
            const pagination = document.getElementById('paginationContainer');

            // If zero, show empty state and remove/hide grid + pagination
            if (next === 0) {
                const emptyState = document.getElementById('emptyState');
                const grid = document.getElementById('favoritesGrid');
                if (grid) grid.remove();
                if (emptyState) emptyState.style.display = 'block';
                if (pagination) pagination.remove();
                return;
            }

            // If we still have items > 0, ensure pagination is visible (in case you re-populate it)
            if (pagination) pagination.style.display = 'flex';
        }


            function setButtonRemoving(btn, removing) {
                btn.disabled = removing;
                if (removing) btn.classList.add('opacity-60');
                else btn.classList.remove('opacity-60');
            }

            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.js-favorite-toggle');
                if (!btn) return;

                e.preventDefault();

                const listingId = btn.getAttribute('data-listing-id');
                if (!listingId) return;

                // Use the AJAX-friendly endpoint for favorites page
                const removeUrl = '@Url.Action("RemoveFromFavoriteInFavorites", "Account")';

                setButtonRemoving(btn, true);

                postFormUrlEncoded(removeUrl, { listingId: listingId })
                    .then(resp => {
                        console.log('Remove favorite response:', resp); // <<-- helpful debug
                        // success (200-299)
                        if (resp.ok) {
                            // Prefer JSON success flag if available
                            if (resp.json && typeof resp.json === 'object') {
                                if (resp.json.success === true || resp.json.success === undefined) {
                                    // remove card and show toast with server message (if provided)
                                    const card = btn.closest('.js-favorite-card');
                                    if (card) {
                                        // smooth fade-out then remove
                                        card.style.transition = 'opacity 220ms, transform 220ms';
                                        card.style.opacity = '0';
                                        card.style.transform = 'scale(0.98)';
                                        setTimeout(() => card.remove(), 240);
                                    }
                                    updateFavoritesCount(-1);
                                    showToast('success', resp.json.message || 'Removed from favourites');
                                    return;
                                } else {
                                    showToast('error', resp.json.message || 'Failed to remove favorite.');
                                    return;
                                }
                            }

                            // If no JSON body, treat 200 as success
                            {
                                const card = btn.closest('.js-favorite-card');
                                if (card) {
                                    card.style.transition = 'opacity 220ms, transform 220ms';
                                    card.style.opacity = '0';
                                    card.style.transform = 'scale(0.98)';
                                    setTimeout(() => card.remove(), 240);
                                }
                                updateFavoritesCount(-1);
                                showToast('success', 'Removed from favourites');
                                return;
                            }
                        }

                        // non-ok (server error). Show message from JSON or fallback to status/text
                        if (resp.json && resp.json.message) {
                            showToast('error', resp.json.message);
                        } else if (resp.text) {
                            showToast('error', 'Server: ' + resp.text.substring(0, 120));
                        } else {
                            showToast('error', 'Server error: ' + resp.status);
                        }
                    })
                    .catch(err => {
                        console.error('Request error', err);
                        showToast('error', 'Request failed. Check console.');
                    })
                    .finally(() => {
                        setButtonRemoving(btn, false);
                    });
            });
        })();
    </script>
}

