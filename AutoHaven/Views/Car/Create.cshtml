@model AutoHaven.ViewModel.CreateCarListingViewModel
@{
    ViewBag.Title = ViewBag.ListingId != null ? "Edit Your Listing" : "List Your Vehicle on AutoHaven";
    Layout = "~/Views/Shared/_Layout.cshtml";

    int? listingId = ViewBag.ListingId as int?;
    var currentImages = ViewBag.CurrentImages as List<AutoHaven.Models.CarImageModel> ?? new List<AutoHaven.Models.CarImageModel>();
    bool isEditing = listingId != null;
}

<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">
        <div class="flex flex-1">
            <main class="flex-1 w-full max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

                <!-- Step Progress Indicator -->
                <div class="flex flex-wrap gap-2 p-4 border-b border-gray-200 dark:border-gray-700 mb-8">
                    <span class="text-primary text-base font-bold leading-normal">1. Vehicle Details</span>
                    <span class="text-[#4c669a] dark:text-gray-500 text-base font-medium leading-normal">/</span>
                    <span class="text-[#4c669a] dark:text-gray-400 text-base font-medium leading-normal">2. Media & Description</span>
                    <span class="text-[#4c669a] dark:text-gray-500 text-base font-medium leading-normal">/</span>
                    <span class="text-[#4c669a] dark:text-gray-400 text-base font-medium leading-normal">3. Pricing</span>
                    <span class="text-[#4c669a] dark:text-gray-500 text-base font-medium leading-normal">/</span>
                    <span class="text-[#4c669a] dark:text-gray-400 text-base font-medium leading-normal">4. Featured</span>
                    @if (isEditing)
                    {
                        <span class="text-[#4c669a] dark:text-gray-500 text-base font-medium leading-normal">/</span>
                        <span class="text-[#4c669a] dark:text-gray-400 text-base font-medium leading-normal">5. Status</span>
                    }
                </div>

                <!-- FORM START -->
             <form action="@(isEditing ? Url.Action("Update", "Car", new { id = listingId }) : Url.Action("Create", "Car"))" 
      method="post" 
      enctype="multipart/form-data"
      id="carListingForm"
      class="bg-white dark:bg-background-dark dark:border dark:border-gray-700 rounded-xl shadow-sm p-6 md:p-8">
    
    @Html.AntiForgeryToken()

    @if (isEditing)
    {
        <input type="hidden" name="imageIdsToKeep" id="imageIdsToKeep" value="" />
    }


                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                            <p class="text-red-800 dark:text-red-300 font-semibold mb-2">Please correct the following errors:</p>
                            <ul class="text-red-700 dark:text-red-400 text-sm space-y-1">
                                @foreach (var modelState in ViewData.ModelState.Values)
                                {
                                    @foreach (var error in modelState.Errors)
                                    {
                                        <li>â€¢ @error.ErrorMessage</li>
                                    }
                                }
                            </ul>
                        </div>
                    }

                    <div class="space-y-6">
                        <!-- ========== STEP 1: VEHICLE DETAILS ========== -->
                        <div class="step-section border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="step-header w-full flex items-center justify-between p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer" data-step="1">
                                <div class="flex items-center gap-3">
                                    <span class="step-number flex items-center justify-center w-8 h-8 rounded-full bg-primary text-white font-bold">1</span>
                                    <div class="text-left">
                                        <h3 class="text-xl font-bold text-[#0d121b] dark:text-white">Vehicle Details</h3>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400">Make, model, year, and specifications</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined step-icon text-[#4c669a] dark:text-gray-400 transition-transform duration-300">expand_more</span>
                            </div>

                            <div class="step-content p-6 space-y-6 border-t border-gray-200 dark:border-gray-700">

                                <!-- Listing Type -->
                                <div>
                                    <h4 class="text-lg font-bold text-[#0d121b] dark:text-white mb-2">Listing Type <span class="text-red-500">*</span></h4>
                                    <p class="text-sm text-[#4c669a] dark:text-gray-400 mb-4">Select whether you want to sell or rent your vehicle.</p>

                                    <div class="flex w-full sm:w-2/3 md:w-1/2 h-10 rounded-lg bg-[#e7ebf3] dark:bg-gray-800 p-1">
                                        <!-- For Sale (ForSelling = 1) -->
                                        <label class="flex flex-1 cursor-pointer items-center justify-center rounded-lg text-sm font-medium transition-all has-[:checked]:bg-white dark:has-[:checked]:bg-gray-700 has-[:checked]:shadow-md has-[:checked]:text-primary text-[#4c669a] dark:text-gray-400">
                                            <span>For Sale</span>
                                            <input type="radio"
                                                   name="ListingType"
                                                   value="1"
                                                   class="hidden listing-type-radio"
                                            @(Model.ListingType == AutoHaven.Models.CarListingModel.ListingType.ForSelling ? "checked" : "") />
                                        </label>

                                        <!-- For Rent (ForRenting = 0) -->
                                        <label class="flex flex-1 cursor-pointer items-center justify-center rounded-lg text-sm font-medium transition-all has-[:checked]:bg-white dark:has-[:checked]:bg-gray-700 has-[:checked]:shadow-md has-[:checked]:text-primary text-[#4c669a] dark:text-gray-400">
                                            <span>For Rent</span>
                                            <input type="radio"
                                                   name="ListingType"
                                                   value="0"
                                                   class="hidden listing-type-radio"
                                            @(Model.ListingType == AutoHaven.Models.CarListingModel.ListingType.ForRenting ? "checked" : "") />
                                        </label>
                                    </div>
                                    @Html.ValidationMessageFor(m => m.ListingType, "", new { @class = "text-red-500 text-sm mt-1" })
                                </div>

                                <!-- Vehicle Information Grid -->
                                <div>
                                    <h4 class="text-lg font-bold text-[#0d121b] dark:text-white mb-4">Vehicle Information</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Make <span class="text-red-500">*</span></p>
                                            @Html.TextBoxFor(m => m.Manufacturer, new { @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal", placeholder = "e.g., Toyota" })
                                            @Html.ValidationMessageFor(m => m.Manufacturer, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Model <span class="text-red-500">*</span></p>
                                            @Html.TextBoxFor(m => m.Model, new { @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal", placeholder = "e.g., Camry" })
                                            @Html.ValidationMessageFor(m => m.Model, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Year <span class="text-red-500">*</span></p>
                                            @Html.TextBoxFor(m => m.ModelYear, new { @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal", type = "number", placeholder = "e.g., 2023", min = "1900", max = "2100" })
                                            @Html.ValidationMessageFor(m => m.ModelYear, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Body Style</p>
                                            @Html.TextBoxFor(m => m.BodyStyle, new { @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal", placeholder = "e.g., Sedan, SUV, Truck" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Color <span class="text-red-500">*</span></p>
                                            @Html.TextBoxFor(m => m.Color, new { @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal", placeholder = "e.g., Black, White, Red" })
                                            @Html.ValidationMessageFor(m => m.Color, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Transmission <span class="text-red-500">*</span></p>
                                            @Html.DropDownListFor(m => m.Transmission,
                                                     new SelectList(Enum.GetValues(typeof(AutoHaven.Models.CarModel.Transmission))
                                                     .Cast<AutoHaven.Models.CarModel.Transmission>()
                                                     .Select(x => new { value = (int)x, text = x.ToString() }), "value", "text"),
                                                     "-- Select Transmission --",
                                                     new { @class = "form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 px-[15px] text-base font-normal leading-normal" })
                                            @Html.ValidationMessageFor(m => m.Transmission, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Fuel Type <span class="text-red-500">*</span></p>
                                            @Html.DropDownListFor(m => m.Fuel,
                                                     new SelectList(Enum.GetValues(typeof(AutoHaven.Models.CarModel.FuelType))
                                                     .Cast<AutoHaven.Models.CarModel.FuelType>()
                                                     .Select(x => new { value = (int)x, text = x.ToString() }), "value", "text"),
                                                     "-- Select Fuel Type --",
                                                     new { @class = "form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 px-[15px] text-base font-normal leading-normal" })
                                            @Html.ValidationMessageFor(m => m.Fuel, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Power (HP) <span class="text-red-500">*</span></p>
                                            @Html.TextBoxFor(m => m.Power, new { @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal", type = "number", placeholder = "e.g., 200", min = "1", max = "10000" })
                                            @Html.ValidationMessageFor(m => m.Power, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                        <label class="flex flex-col">
                                            <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Number of Doors <span class="text-red-500">*</span></p>
                                            @Html.TextBoxFor(m => m.Doors, new { @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal", type = "number", placeholder = "e.g., 4", min = "1", max = "10" })
                                            @Html.ValidationMessageFor(m => m.Doors, "", new { @class = "text-red-500 text-sm mt-1" })
                                        </label>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ========== STEP 2: MEDIA & DESCRIPTION ========== -->
  <div class="step-section border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="step-header w-full flex items-center justify-between p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer" data-step="2">
                                <div class="flex items-center gap-3">
                                    <span class="step-number flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-white font-bold">2</span>
                                    <div class="text-left">
                                        <h3 class="text-xl font-bold text-[#0d121b] dark:text-white">Media & Description</h3>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400">Upload images and describe your vehicle</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined step-icon text-[#4c669a] dark:text-gray-400 transition-transform duration-300">expand_more</span>
                            </div>

                            <div class="step-content hidden p-6 space-y-6 border-t border-gray-200 dark:border-gray-700">

                                <!-- âœ… EXISTING IMAGES (Edit Mode Only) -->
                                @if (isEditing && currentImages.Any())
                                {
                                    <div>
                                        <h4 class="text-lg font-bold text-[#0d121b] dark:text-white mb-3">Current Images</h4>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400 mb-4">Uncheck images you want to remove</p>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            @foreach (var img in currentImages)
                                            {
                                                <div class="relative group">
                                                    <img src="/@img.Path" alt="@img.AltText" class="w-full h-24 object-cover rounded-lg border border-gray-300 dark:border-gray-600">
                                                    <label class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-lg hover:bg-black/60 transition-all cursor-pointer">
                                                        <input type="checkbox" value="@img.CarImageId" checked class="w-4 h-4 keep-image-checkbox">
                                                        <span class="text-white text-xs font-bold ml-2">Keep</span>
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <hr class="border-gray-200 dark:border-gray-700">
                                }

                                <!-- Image Upload -->
                                <div>
                                    <h4 class="text-lg font-bold text-[#0d121b] dark:text-white mb-2">
                                        @(isEditing ? "Add More Images" : "Vehicle Images")
                                    </h4>
                                    <p class="text-sm text-[#4c669a] dark:text-gray-400 mb-4">
                                        Upload up to @(7 - currentImages.Count) @(isEditing ? "more " : "")images. Drag and drop or click to select.
                                    </p>

                                    <div id="dropZone" class="border-2 border-dashed border-[#cfd7e7] dark:border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-primary dark:hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors">
                                        <input type="file" id="imageInput" name="imageFiles" multiple accept="image/*" class="hidden">
                                        <span class="material-symbols-outlined text-4xl text-[#4c669a] dark:text-gray-400 mb-2 block">cloud_upload</span>
                                        <p class="text-[#0d121b] dark:text-white font-semibold mb-1">Drag images here or click to select</p>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400">Supported formats: JPG, PNG, GIF, WebP</p>
                                        <p class="text-xs text-[#4c669a] dark:text-gray-500 mt-2">Maximum @(7 - currentImages.Count) images</p>
                                    </div>

                                    <div id="imageList" class="mt-6 space-y-3"></div>
                                </div>

                                <!-- Description -->
                                <div>
                                    <h4 class="text-lg font-bold text-[#0d121b] dark:text-white mb-2">Description</h4>
                                    <p class="text-sm text-[#4c669a] dark:text-gray-400 mb-4">Provide detailed information about your vehicle's condition, features, and history.</p>
                                    @Html.TextAreaFor(m => m.Description, new
                                        {
                                            @class = "form-textarea flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal",
                                            rows = "6",
                                            placeholder = "e.g., Excellent condition, well-maintained, no accidents, full service history..."
                                        })
                                    @Html.ValidationMessageFor(m => m.Description, "", new { @class = "text-red-500 text-sm mt-1" })
                                </div>
                            </div>
                        </div>

                        <!-- ==================== STEP 3: PRICING ==================== -->
                        <div class="step-section border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="step-header w-full flex items-center justify-between p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer" data-step="3">
                                <div class="flex items-center gap-3">
                                    <span class="step-number flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-white font-bold">3</span>
                                    <div class="text-left">
                                        <h3 class="text-xl font-bold text-[#0d121b] dark:text-white">Pricing</h3>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400">Set your price</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined step-icon text-[#4c669a] dark:text-gray-400 transition-transform duration-300">expand_more</span>
                            </div>

                            <div class="step-content hidden p-6 space-y-6 border-t border-gray-200 dark:border-gray-700">
                                <div>
                                    <h4 class="text-lg font-bold text-[#0d121b] dark:text-white mb-4">Set Your Price</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                        <div id="salePriceContainer" class="price-container">
                                            <label class="flex flex-col">
                                                <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Sale Price <span class="text-red-500">*</span></p>
                                                @Html.TextBoxFor(m => m.NewPrice, new
                                                    {
                                                        @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal",
                                                        type = "number",
                                                        step = "0.01",
                                                        placeholder = "e.g., 25000.00",
                                                        min = "0.01",
                                                        max = "999999999",
                                                        id = "NewPriceInput"
                                                    })
                                                @Html.ValidationMessageFor(m => m.NewPrice, "", new { @class = "text-red-500 text-sm mt-1" })
                                            </label>
                                        </div>

                                        <div id="rentalPriceContainer" class="price-container hidden">
                                            <label class="flex flex-col">
                                                <p class="text-[#0d121b] dark:text-gray-200 text-base font-medium leading-normal pb-2">Rental Price (Per Day) <span class="text-red-500">*</span></p>
                                                @Html.TextBoxFor(m => m.RentPrice, new
                                                    {
                                                        @class = "form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d121b] dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#cfd7e7] dark:border-gray-600 bg-background-light dark:bg-gray-800 h-14 placeholder:text-[#4c669a] dark:placeholder:text-gray-500 p-[15px] text-base font-normal leading-normal",
                                                        type = "number",
                                                        step = "0.01",
                                                        placeholder = "e.g., 75.00",
                                                        min = "0.01",
                                                        max = "999999",
                                                        id = "RentPriceInput"
                                                    })
                                                @Html.ValidationMessageFor(m => m.RentPrice, "", new { @class = "text-red-500 text-sm mt-1" })
                                            </label>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ==================== STEP 4: FEATURED ==================== -->
                        <div class="step-section border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="step-header w-full flex items-center justify-between p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer" data-step="4">
                                <div class="flex items-center gap-3">
                                    <span class="step-number flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-white font-bold">4</span>
                                    <div class="text-left">
                                        <h3 class="text-xl font-bold text-[#0d121b] dark:text-white">Featured Listing</h3>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400">Make your car stand out</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined step-icon text-[#4c669a] dark:text-gray-400 transition-transform duration-300">expand_more</span>
                            </div>

                            <div class="step-content hidden p-6 space-y-4 border-t border-gray-200 dark:border-gray-700">

                                <div class="flex items-start gap-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                    <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 mt-1">star</span>
                                    <div>
                                        <p class="text-sm font-semibold text-yellow-900 dark:text-yellow-300">Featured Listing Benefits</p>
                                        <ul class="text-sm text-yellow-800 dark:text-yellow-400 mt-2 space-y-1">
                                            <li>âœ“ Appears on homepage in featured section</li>
                                            <li>âœ“ Gets priority visibility in search results</li>
                                            <li>âœ“ Up to 3x more views than regular listings</li>
                                            <li>âœ“ Special "Featured" badge on your listing</li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:border-primary hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-all cursor-pointer group">
                                    @Html.CheckBoxFor(m => m.WantsFeatured, new
                                        {
                                            @class = "w-5 h-5 text-primary rounded cursor-pointer focus:ring-2 focus:ring-primary",
                                            id = "wantsFeatured"
                                        })
                                    <label for="wantsFeatured" class="flex-1 cursor-pointer">
                                        <p class="font-semibold text-[#0d121b] dark:text-white group-hover:text-primary transition-colors">ðŸŒŸ Feature This Listing</p>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400">Featured cars get more visibility!</p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- ==================== STEP 5: STATUS (EDIT MODE ONLY) ==================== -->
                        @if (isEditing)
                        {
                            <div class="step-section border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                <div class="step-header w-full flex items-center justify-between p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer" data-step="5">
                                    <div class="flex items-center gap-3">
                                        <span class="step-number flex items-center justify-center w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-white font-bold">5</span>
                                        <div class="text-left">
                                            <h3 class="text-xl font-bold text-[#0d121b] dark:text-white">Listing Status</h3>
                                            <p class="text-sm text-[#4c669a] dark:text-gray-400">Update availability status</p>
                                        </div>
                                    </div>
                                    <span class="material-symbols-outlined step-icon text-[#4c669a] dark:text-gray-400 transition-transform duration-300">expand_more</span>
                                </div>

                                <div class="step-content hidden p-6 space-y-6 border-t border-gray-200 dark:border-gray-700">
                                    <div>
                                        <h4 class="text-lg font-bold text-[#0d121b] dark:text-white mb-2">Current Status</h4>
                                        <p class="text-sm text-[#4c669a] dark:text-gray-400 mb-4">Mark your listing as Sold/Rented when transaction is complete, or Unavailable to temporarily hide it.</p>

                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">

                                            <!-- Available -->
                                            <label class="cursor-pointer">
                                                <input type="radio" name="CurrentState" value="3" class="hidden peer" @(Model.CurrentState == AutoHaven.Models.CarListingModel.State.Available ? "checked" : "") />
                                                <div class="p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-green-500 dark:hover:border-green-500 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 dark:peer-checked:bg-green-900/20">
                                                    <div class="flex flex-col items-center text-center">
                                                        <span class="material-symbols-outlined text-3xl text-green-500 mb-2">check_circle</span>
                                                        <span class="font-semibold text-[#0d121b] dark:text-white">Available</span>
                                                        <span class="text-xs text-[#4c669a] dark:text-gray-400 mt-1">Visible to buyers</span>
                                                    </div>
                                                </div>
                                            </label>

                                            <!-- Sold -->
                                            <label class="cursor-pointer">
                                                <input type="radio" name="CurrentState" value="0" class="hidden peer" @(Model.CurrentState == AutoHaven.Models.CarListingModel.State.Sold ? "checked" : "") />
                                                <div class="p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-500 transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20">
                                                    <div class="flex flex-col items-center text-center">
                                                        <span class="material-symbols-outlined text-3xl text-blue-500 mb-2">sell</span>
                                                        <span class="font-semibold text-[#0d121b] dark:text-white">Sold</span>
                                                        <span class="text-xs text-[#4c669a] dark:text-gray-400 mt-1">Sale completed</span>
                                                    </div>
                                                </div>
                                            </label>

                                            <!-- Rented -->
                                            <label class="cursor-pointer">
                                                <input type="radio" name="CurrentState" value="1" class="hidden peer" @(Model.CurrentState == AutoHaven.Models.CarListingModel.State.Rented ? "checked" : "") />
                                                <div class="p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-purple-500 dark:hover:border-purple-500 transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20">
                                                    <div class="flex flex-col items-center text-center">
                                                        <span class="material-symbols-outlined text-3xl text-purple-500 mb-2">key</span>
                                                        <span class="font-semibold text-[#0d121b] dark:text-white">Rented</span>
                                                        <span class="text-xs text-[#4c669a] dark:text-gray-400 mt-1">Currently rented</span>
                                                    </div>
                                                </div>
                                            </label>

                                            <!-- Unavailable -->
                                            <label class="cursor-pointer">
                                                <input type="radio" name="CurrentState" value="2" class="hidden peer" @(Model.CurrentState == AutoHaven.Models.CarListingModel.State.Unavaliable ? "checked" : "") />
                                                <div class="p-4 rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-orange-500 dark:hover:border-orange-500 transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 dark:peer-checked:bg-orange-900/20">
                                                    <div class="flex flex-col items-center text-center">
                                                        <span class="material-symbols-outlined text-3xl text-orange-500 mb-2">visibility_off</span>
                                                        <span class="font-semibold text-[#0d121b] dark:text-white">Unavailable</span>
                                                        <span class="text-xs text-[#4c669a] dark:text-gray-400 mt-1">Temporarily hidden</span>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>

                                        <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                            <div class="flex items-start gap-3">
                                                <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 mt-0.5">info</span>
                                                <div class="text-sm text-blue-800 dark:text-blue-300">
                                                    <p class="font-semibold mb-1">Status Guide:</p>
                                                    <ul class="list-disc list-inside space-y-1 text-blue-700 dark:text-blue-400">
                                                        <li><strong>Available:</strong> Your listing is visible and active</li>
                                                        <li><strong>Sold:</strong> Vehicle has been sold</li>
                                                        <li><strong>Rented:</strong> Vehicle is currently rented out</li>
                                                        <li><strong>Unavailable:</strong> Temporarily hide your listing</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                    </div>
                    <!-- END space-y-6 -->
                    <!-- ==================== ACTION BUTTONS ==================== -->
                    <div class="mt-10 pt-6 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <a href="@Url.Action("Index", "Car")" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 bg-transparent text-[#4c669a] dark:text-gray-400 gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-6 hover:bg-gray-100 dark:hover:bg-gray-800">
                            <span class="truncate">Cancel</span>
                        </a>
                        <button type="submit" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] gap-2">
                            <span class="truncate">@(isEditing ? "Update Listing" : "Publish Listing")</span>
                            <span class="material-symbols-outlined">@(isEditing ? "edit" : "check_circle")</span>
                        </button>
                    </div>
                </form>

            </main>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ðŸš€ Form initializing...');

            // ===== ELEMENTS =====
            const dropZone = document.getElementById('dropZone');
            const imageInput = document.getElementById('imageInput');
            const imageList = document.getElementById('imageList');
            const listingTypeRadios = document.querySelectorAll('input[name="ListingType"]');
            const salePriceContainer = document.getElementById('salePriceContainer');
            const rentalPriceContainer = document.getElementById('rentalPriceContainer');
            const newPriceInput = document.getElementById('NewPriceInput');
            const rentPriceInput = document.getElementById('RentPriceInput');
            const form = document.querySelector('#carListingForm');
            const wantsFeaturedCheckbox = document.getElementById('wantsFeatured');

            const maxImages = 7;
            const existingImageCount = @currentImages.Count;
            const isEditMode = @(isEditing ? "true" : "false");
            let uploadedFiles = [];

            // âœ… Store original values for edit mode
            const originalValues = {
                listingType: '@((int)Model.ListingType)',
                newPrice: '@(Model.NewPrice?.ToString() ?? "")',
                rentPrice: '@(Model.RentPrice?.ToString() ?? "")'
            };

            console.log('ðŸ“‹ Edit mode:', isEditMode, '| Existing images:', existingImageCount);
            console.log('ðŸ“‹ Original values:', originalValues);

            // ============================================
            // ===== ACCORDION FUNCTIONALITY =====
            // ============================================
            const stepHeaders = document.querySelectorAll('.step-header');

            stepHeaders.forEach(function (header) {
                header.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const stepSection = this.closest('.step-section');
                    if (!stepSection) return;

                    const content = stepSection.querySelector('.step-content');
                    const icon = this.querySelector('.step-icon');
                    const stepNumber = this.querySelector('.step-number');

                    if (!content) return;

                    const isHidden = content.classList.contains('hidden');
                    const stepId = this.getAttribute('data-step');

                    if (isHidden) {
                        content.classList.remove('hidden');
                        if (icon) icon.style.transform = 'rotate(180deg)';
                        if (stepNumber) {
                            stepNumber.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                            stepNumber.classList.add('bg-primary');
                        }
                        console.log('ðŸ“‚ Opened step:', stepId);
                    } else {
                        content.classList.add('hidden');
                        if (icon) icon.style.transform = 'rotate(0deg)';
                        if (stepNumber) {
                            stepNumber.classList.remove('bg-primary');
                            stepNumber.classList.add('bg-gray-300', 'dark:bg-gray-600');
                        }
                        console.log('ðŸ“ Closed step:', stepId);
                    }
                });
            });

            // ============================================
            // ===== LISTING TYPE TOGGLE =====
            // ============================================
            function updatePriceVisibility(listingTypeValue, preserveValues = false) {
                console.log('ðŸ’° Listing type:', listingTypeValue, '| Preserve values:', preserveValues);

                if (listingTypeValue === "1") {
                    // FOR SELLING
                    if (salePriceContainer) salePriceContainer.classList.remove('hidden');
                    if (rentalPriceContainer) rentalPriceContainer.classList.add('hidden');

                    // âœ… Don't clear values in edit mode if preserveValues is true
                    if (!preserveValues && rentPriceInput) {
                        rentPriceInput.value = '';
                    }

                    console.log('âœ… Showing SALE price input');
                } else if (listingTypeValue === "0") {
                    // FOR RENTING
                    if (salePriceContainer) salePriceContainer.classList.add('hidden');
                    if (rentalPriceContainer) rentalPriceContainer.classList.remove('hidden');

                    // âœ… Don't clear values in edit mode if preserveValues is true
                    if (!preserveValues && newPriceInput) {
                        newPriceInput.value = '';
                    }

                    console.log('âœ… Showing RENT price input');
                }
            }

            listingTypeRadios.forEach(function (radio) {
                radio.addEventListener('change', function () {
                    // When user manually changes, don't preserve old values
                    updatePriceVisibility(this.value, false);
                });
            });

            // âœ… Initialize pricing on page load - PRESERVE values in edit mode
            const checkedRadio = document.querySelector('input[name="ListingType"]:checked');
            if (checkedRadio) {
                updatePriceVisibility(checkedRadio.value, isEditMode);
            } else {
                // Default to selling if nothing selected (new listing)
                const defaultRadio = document.querySelector('input[name="ListingType"][value="1"]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                }
                updatePriceVisibility("1", false);
            }

            // ============================================
            // ===== IMAGE DRAG & DROP =====
            // ============================================
            if (dropZone && imageInput) {
                // âœ… FIXED: Click to upload
                dropZone.addEventListener('click', function () {
                    imageInput.click();
                });

                // Drag over
                dropZone.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900/10');
                });

                // Drag leave
                dropZone.addEventListener('dragleave', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/10');
                });

                // Drop
                dropZone.addEventListener('drop', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/10');
                    const files = Array.from(e.dataTransfer.files).filter(function (f) {
                        return f.type.startsWith('image/');
                    });
                    handleFiles(files);
                });

                // âœ… FIXED: File input change
                imageInput.addEventListener('change', function () {
                    if (this.files && this.files.length > 0) {
                        handleFiles(Array.from(this.files));
                    }
                });
            }

            function handleFiles(files) {
                const availableSlots = maxImages - existingImageCount - uploadedFiles.length;

                if (availableSlots <= 0) {
                    alert('âŒ Maximum ' + maxImages + ' images allowed. You already have ' + existingImageCount + ' existing images.');
                    return;
                }

                const filesToAdd = files.slice(0, availableSlots);

                if (filesToAdd.length < files.length) {
                    alert('âš ï¸ Only ' + availableSlots + ' more images can be added. ' + (files.length - filesToAdd.length) + ' files were skipped.');
                }

                uploadedFiles = uploadedFiles.concat(filesToAdd);
                renderImageList();
                updateFileInput();
                updateImageValidationMessage();

                console.log('ðŸ“¸ Added ' + filesToAdd.length + ' images. Total new: ' + uploadedFiles.length);
            }

            function renderImageList() {
                if (!imageList) return;

                imageList.innerHTML = '';

                if (uploadedFiles.length === 0) {
                    imageList.innerHTML = '<p class="text-[#4c669a] dark:text-gray-400 text-sm">No new images selected</p>';
                    return;
                }

                uploadedFiles.forEach(function (file, index) {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700';

                    const primaryBadge = index === 0 && existingImageCount === 0
                        ? '<span class="bg-primary text-white text-xs font-bold px-2 py-1 rounded ml-2">Primary</span>'
                        : '';

                    imageItem.innerHTML =
                        '<div class="flex items-center gap-3 flex-1">' +
                        '<span class="material-symbols-outlined text-primary">image</span>' +
                        '<div class="flex-1 min-w-0">' +
                        '<p class="text-[#0d121b] dark:text-white font-medium truncate">' + file.name + '</p>' +
                        '<p class="text-sm text-[#4c669a] dark:text-gray-400">' + (file.size / 1024 / 1024).toFixed(2) + ' MB</p>' +
                        '</div>' +
                        primaryBadge +
                        '</div>' +
                        '<button type="button" class="delete-btn ml-2 flex items-center justify-center h-10 px-3 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-md transition-colors" data-index="' + index + '">' +
                        '<span class="material-symbols-outlined text-lg">delete</span>' +
                        '</button>';

                    const deleteBtn = imageItem.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const idx = parseInt(this.getAttribute('data-index'));
                        uploadedFiles.splice(idx, 1);
                        renderImageList();
                        updateFileInput();
                        updateImageValidationMessage();
                        console.log('ðŸ—‘ï¸ Removed new image. Remaining: ' + uploadedFiles.length);
                    });

                    imageList.appendChild(imageItem);
                });
            }

            function updateFileInput() {
                if (!imageInput) return;
                const dataTransfer = new DataTransfer();
                uploadedFiles.forEach(function (file) {
                    dataTransfer.items.add(file);
                });
                imageInput.files = dataTransfer.files;
            }

            // âœ… NEW: Update validation message based on image state
            function updateImageValidationMessage() {
                const keepCheckboxes = document.querySelectorAll('.keep-image-checkbox');
                const checkedKeepCheckboxes = document.querySelectorAll('.keep-image-checkbox:checked');
                const hasNewImages = uploadedFiles.length > 0;
                const keptOldCount = checkedKeepCheckboxes.length;

                // Find or create validation message element
                let validationMsg = document.getElementById('imageValidationMsg');
                if (!validationMsg) {
                    validationMsg = document.createElement('div');
                    validationMsg.id = 'imageValidationMsg';
                    validationMsg.className = 'mt-4 p-3 rounded-lg text-sm';
                    const dropZoneParent = dropZone ? dropZone.parentElement : null;
                    if (dropZoneParent) {
                        dropZoneParent.appendChild(validationMsg);
                    }
                }

                if (isEditMode && keepCheckboxes.length > 0) {
                    if (hasNewImages) {
                        // âœ… Has new images - can remove all old ones
                        validationMsg.className = 'mt-4 p-3 rounded-lg text-sm bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-300';
                        validationMsg.innerHTML = 'âœ… You have new images - you can remove all existing photos if you want.';
                    } else if (keptOldCount === 0) {
                        // âŒ No new images AND no old images kept
                        validationMsg.className = 'mt-4 p-3 rounded-lg text-sm bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300';
                        validationMsg.innerHTML = 'âŒ You must keep at least 1 existing photo OR upload new ones.';
                    } else {
                        // âœ… Keeping some old images
                        validationMsg.className = 'mt-4 p-3 rounded-lg text-sm bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-300';
                        validationMsg.innerHTML = 'ðŸ“· Keeping ' + keptOldCount + ' existing photo(s).';
                    }
                    validationMsg.style.display = 'block';
                } else {
                    validationMsg.style.display = 'none';
                }
            }

            // âœ… Add event listeners to keep-image checkboxes
            const keepImageCheckboxes = document.querySelectorAll('.keep-image-checkbox');
            keepImageCheckboxes.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    updateImageValidationMessage();
                    console.log('ðŸ–¼ï¸ Keep image checkbox changed');
                });
            });

            // Initialize validation message
            if (isEditMode) {
                updateImageValidationMessage();
            }

            // ============================================
            // ===== FEATURED CHECKBOX =====
            // ============================================
            if (wantsFeaturedCheckbox) {
                wantsFeaturedCheckbox.addEventListener('change', function () {
                    console.log('â­ Featured listing:', this.checked ? 'ENABLED' : 'DISABLED');
                });
            }

            // ============================================
            // ===== STATUS RADIO BUTTONS (EDIT MODE) =====
            // ============================================
            const statusRadios = document.querySelectorAll('input[name="CurrentState"]');
            statusRadios.forEach(function (radio) {
                radio.addEventListener('change', function () {
                    const statusNames = { '0': 'Sold', '1': 'Rented', '2': 'Unavailable', '3': 'Available' };
                    console.log('ðŸ“Š Status changed to:', statusNames[this.value] || this.value);
                });
            });

            // ============================================
            // ===== FORM VALIDATION & SUBMIT =====
            // ============================================
            if (form) {
                form.addEventListener('submit', function (e) {
                    console.log('ðŸ“¤ Form submission started...');

                    // ===== 1. VALIDATE LISTING TYPE =====
                    const selectedRadio = document.querySelector('input[name="ListingType"]:checked');
                    if (!selectedRadio) {
                        e.preventDefault();
                        alert('âŒ Please select a listing type (For Sale or For Rent)');
                        return false;
                    }

                    const listingTypeValue = selectedRadio.value;
                    const salePrice = parseFloat(newPriceInput ? newPriceInput.value : 0) || 0;
                    const rentalPrice = parseFloat(rentPriceInput ? rentPriceInput.value : 0) || 0;

                    // ===== 2. VALIDATE PRICING =====
                    if (listingTypeValue === "1" && salePrice <= 0) {
                        e.preventDefault();
                        alert('âŒ Please enter a valid sale price (must be greater than 0)');
                        if (newPriceInput) newPriceInput.focus();
                        return false;
                    }

                    if (listingTypeValue === "0" && rentalPrice <= 0) {
                        e.preventDefault();
                        alert('âŒ Please enter a valid rental price per day (must be greater than 0)');
                        if (rentPriceInput) rentPriceInput.focus();
                        return false;
                    }

                    // ===== 3. VALIDATE IMAGES =====
                    const keepCheckboxes = document.querySelectorAll('.keep-image-checkbox:checked');
                    const keptOldCount = keepCheckboxes.length;
                    const hasNewImages = uploadedFiles.length > 0;
                    const totalOldImages = existingImageCount;

                    console.log('ðŸ–¼ï¸ Image validation:', {
                        totalOldImages: totalOldImages,
                        keptOldCount: keptOldCount,
                        newImagesCount: uploadedFiles.length,
                        hasNewImages: hasNewImages
                    });

                    // âœ… EDIT MODE: Image validation
                    if (isEditMode) {
                        // Rule: If NO new images uploaded, must keep at least 1 old image
                        if (!hasNewImages && keptOldCount === 0) {
                            e.preventDefault();
                            alert('âŒ You must keep at least 1 existing photo OR upload new ones.');
                            return false;
                        }
                        console.log('âœ… Edit mode image validation passed');
                    } else {
                        // âœ… CREATE MODE: Must have at least 1 image
                        if (uploadedFiles.length === 0) {
                            e.preventDefault();
                            alert('âŒ Please upload at least 1 image for your listing.');
                            return false;
                        }
                        console.log('âœ… Create mode image validation passed');
                    }

                    // ===== 4. COLLECT IMAGE IDS TO KEEP =====
                    const imageIdsToKeep = Array.from(keepCheckboxes).map(function (cb) {
                        return cb.value;
                    });

                    const hiddenInput = document.getElementById('imageIdsToKeep');
                    if (hiddenInput) {
                        hiddenInput.value = imageIdsToKeep.join(',');
                        console.log('ðŸ–¼ï¸ Images to keep:', imageIdsToKeep);
                    }

                    // ===== 5. GET STATUS VALUE (EDIT MODE) =====
                    const statusRadio = document.querySelector('input[name="CurrentState"]:checked');
                    const statusValue = statusRadio ? statusRadio.value : 'N/A';

                    // ===== 6. LOG FINAL DATA =====
                    console.log('âœ… Form validation passed!');
                    console.log('ðŸ“Š Final submission data:', {
                        listingType: listingTypeValue === "1" ? "For Sale" : "For Rent",
                        salePrice: salePrice,
                        rentalPrice: rentalPrice,
                        newImagesCount: uploadedFiles.length,
                        keptOldImagesCount: keptOldCount,
                        keptImageIds: imageIdsToKeep,
                        featured: wantsFeaturedCheckbox ? wantsFeaturedCheckbox.checked : false,
                        status: statusValue
                    });

                    return true;
                });
            }

            // ============================================
            // ===== INITIALIZE =====
            // ============================================
            console.log('âœ… Form fully initialized and ready!');
        });
    </script>
}