@model AutoHaven.Models.CarListingModel

@{
    ViewBag.Title = Model.Car.Manufacturer + " " + Model.Car.Model + " - AutoHaven";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentUserId = ViewBag.CurrentUserId as int?;
    var isOwner = currentUserId == Model.UserId;
}

<div class="min-h-screen bg-background-light dark:bg-background-dark">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Breadcrumb -->
        <nav class="mb-8 flex items-center gap-2 text-sm">
            <a href="/">Home</a>
            <span class="text-gray-400">/</span>
            <a href="@Url.Action("Index", "Car")" class="text-primary hover:underline">Listings</a>
            <span class="text-gray-400">/</span>
            <span class="text-gray-600 dark:text-gray-400">@Model.Car.Manufacturer @Model.Car.Model</span>
        </nav>

        <!-- Title & Price -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-[#0d121b] dark:text-white mb-2">
                @Model.Car.ModelYear @Model.Car.Manufacturer @Model.Car.Model
            </h1>
            <div class="flex items-center justify-between">
                <p class="text-3xl font-bold text-primary">
                    $@(Model.Type == AutoHaven.Models.CarListingModel.ListingType.ForSelling ?
                       Model.NewPrice.ToString("F2") :
                       Model.RentPrice.ToString("F2"))
                    @if (Model.Type == AutoHaven.Models.CarListingModel.ListingType.ForRenting)
                    {
                        <span class="text-lg text-gray-600 dark:text-gray-400">/per day</span>
                    }
                </p>
                <span class="text-sm text-gray-500 dark:text-gray-400">
                    <span class="material-symbols-outlined inline-block align-middle mr-1">visibility</span>
                    @Model.Views views
                </span>
            </div>
        </div>

        <!-- Main Content Grid: 2/3 Images + 1/3 Sidebar -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- ========== LEFT SIDE: IMAGES (2/3 WIDTH) ========== -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-sm">

                    <!-- Primary Image -->
                    <div class="aspect-square bg-gray-100 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                        @{
                            var primaryImage = Model.CarImages?.FirstOrDefault(img => img.IsPrimary)
                            ?? Model.CarImages?.FirstOrDefault();
                        }
                        @if (primaryImage != null)
                        {
                            <img id="mainImage"
                                 src="/@primaryImage.Path"
                                 alt="@primaryImage.AltText"
                                 class="w-full h-full object-cover">
                        }
                        else
                        {
                            <div class="flex flex-col items-center justify-center text-gray-400">
                                <span class="material-symbols-outlined text-6xl">image</span>
                                <p class="mt-2">No image available</p>
                            </div>
                        }
                    </div>

                    <!-- Thumbnail Gallery -->
                    @if (Model.CarImages != null && Model.CarImages.Count > 0)
                    {
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 flex gap-2 overflow-x-auto">
                            @foreach (var img in Model.CarImages)
                            {
                                <button type="button"
                                        class="thumbnail-btn flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 border-transparent hover:border-primary transition-all"
                                        onclick="changeMainImage('/@img.Path')">
                                    <img src="/@img.Path"
                                         alt="@img.AltText"
                                         class="w-full h-full object-cover">
                                </button>
                            }
                        </div>
                    }
                </div>

                <!-- Specifications -->
                <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <h2 class="text-2xl font-bold text-[#0d121b] dark:text-white mb-6">Specifications</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Year</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@Model.Car.ModelYear</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Fuel Type</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@Model.Car.CurrentFuel</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Transmission</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@Model.Car.CurrentTransmission</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Power</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@Model.Car.Power HP</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Color</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@Model.Color</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Doors</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@Model.Car.Doors</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Condition</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@Model.CurrentState</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Body Style</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">@(Model.Car.BodyStyle ?? "N/A")</p>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <h2 class="text-2xl font-bold text-[#0d121b] dark:text-white mb-4">Description</h2>
                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
                        @(Model.Description ?? "No description provided.")
                    </p>
                </div>

                <!-- Reviews Section -->
                <div class="mt-8 bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-[#0d121b] dark:text-white">Reviews & Ratings</h3>
                            <div class="flex items-center gap-3 mt-2">
                                @{
                                    double avgRating = ViewBag.AverageRating ?? 0;
                                    int reviewCount = ViewBag.ReviewCount ?? 0;
                                }
                                <div class="flex gap-0.5">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Math.Floor(avgRating))
                                        {
                                            <span class="material-symbols-outlined text-yellow-400">star</span>
                                        }
                                        else
                                        {
                                            <span class="material-symbols-outlined text-gray-300">star</span>
                                        }
                                    }
                                </div>
                                <span class="font-bold text-[#0d121b] dark:text-white">@avgRating.ToString("F1")</span>
                                <span class="text-gray-600 dark:text-gray-400">(@reviewCount reviews)</span>
                            </div>
                        </div>

                        <!-- Add Review Button -->
                        @if (User.Identity.IsAuthenticated && !(ViewBag.IsOwner ?? false))
                        {
                            <button class="px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-blue-600 text-sm"
                                    onclick="openReviewModal()">
                                Add Review
                            </button>
                        }
                        else if (!User.Identity.IsAuthenticated)
                        {
                            <a href="@Url.Action("Login", "Account")" class="px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-blue-600 text-sm">
                                Log In to Review
                            </a>
                        }
                    </div>

                    <!-- Reviews List -->
                    <div class="space-y-4">
                        @if (ViewBag.Reviews != null && ViewBag.Reviews.Count > 0)
                        {
                            @foreach (var review in ViewBag.Reviews)
                            {
                                <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="font-bold text-[#0d121b] dark:text-white text-sm">
                                                @(review.User?.UserName ?? review.User?.FirstName ?? "Anonymous")
                                            </p>
                                            <div class="flex items-center gap-2 mt-1">
                                                <div class="flex gap-0.5">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        if (i <= review.Rating)
                                                        {
                                                            <span class="material-symbols-outlined text-yellow-400 text-xs">star</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="material-symbols-outlined text-gray-300 text-xs">star</span>
                                                        }
                                                    }
                                                </div>
                                                <span class="text-xs text-gray-600 dark:text-gray-400">@review.CreatedAt.ToString("MMM dd, yyyy")</span>
                                            </div>
                                        </div>

                                        <!-- Edit & Delete Buttons -->
                                        @if (User.Identity.IsAuthenticated && review.UserId == (ViewBag.CurrentUserId ?? 0))
                                        {
                                            <div class="flex gap-2">
                                                <button type="button" class="text-blue-600 hover:underline text-xs"
                                                        onclick="toggleEdit(@review.ReviewId)">
                                                    Edit
                                                </button>
                                                <button type="button" class="text-red-500 hover:text-red-700 text-xs"
                                                        onclick="deleteReview(@review.ReviewId, @Model.ListingId)">
                                                    Delete
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- Review Comment -->
                                    <p class="text-gray-700 dark:text-gray-300 text-sm">@review.Comment</p>

                                <!-- Inline Edit Form with Stars -->
                                @if (User.Identity.IsAuthenticated && review.UserId == (ViewBag.CurrentUserId ?? 0))
                                {
                                    <form id="edit-form-@review.ReviewId"
                                          method="post"
                                          action="@Url.Action("EditReview", "Review")"
                                          class="mt-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">

                                        @Html.AntiForgeryToken()

                                        <input type="hidden" name="reviewId" value="@review.ReviewId" />
                                        <input type="hidden" name="listingId" value="@Model.ListingId" />
                                        <input type="hidden" name="rating" id="edit-rating-@review.ReviewId" value="@review.Rating" />

                                        <label class="text-sm font-semibold dark:text-white">Edit Comment</label>
                                        <textarea name="comment" rows="3"
                                                  class="w-full mt-1 p-2 border rounded-lg dark:bg-gray-600 dark:text-white"
                                                  required>@review.Comment</textarea>

                                        <label class="text-sm font-semibold dark:text-white mt-3 block">Edit Rating</label>
                                        <div class="flex gap-2 mt-1" id="edit-stars-@review.ReviewId">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                var starClass = i <= review.Rating ? "text-yellow-400" : "text-gray-300";
                                                <button type="button" class="material-symbols-outlined text-2xl cursor-pointer star-edit @starClass"
                                                        data-rating="@i"
                                                        onclick="setEditRating(@review.ReviewId, @i)">
                                                    star
                                                </button>
                                            }
                                        </div>

                                        <button type="submit"
                                                class="mt-3 px-4 py-2 bg-primary text-white rounded-lg text-sm">
                                            Save Changes
                                        </button>
                                    </form>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-gray-600 dark:text-gray-400 text-center py-4 text-sm">No reviews yet. Be the first to review!</p>
                        }
                    </div>
                </div>
            </div>

            <!-- ========== RIGHT SIDE: ACTIONS & SELLER INFO (1/3 WIDTH) ========== -->
            <div class="lg:col-span-1">

                <!-- Add to Favorites -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm mb-6">
                    <button id="favoriteBtn"
                            class="w-full py-3 px-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                            onclick="toggleFavorite()">
                        <span class="material-symbols-outlined">favorite</span>
                        <span id="favBtnText">Add to Favorites</span>
                    </button>
                </div>

                <!-- Contact Seller -->
                @if (!isOwner)
                {
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm top-8 mb-6">
                        <h3 class="text-xl font-bold text-[#0d121b] dark:text-white mb-6">Contact Seller</h3>

                        <!-- Phone -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Phone</p>
                            <p class="text-lg font-semibold text-[#0d121b] dark:text-white">
                                @(Model.User?.PhoneNumber ?? "Not provided")
                            </p>
                        </div>

                        <!-- Contact Button - WhatsApp -->
                        <a href="@($"https://wa.me/{Model.User?.PhoneNumber}?text=Hello I am interested in your Offer for The {Model.Car.Manufacturer} {Model.Car.Model}")"
                           target="_blank"
                           class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 mb-3">
                            <span class="material-symbols-outlined">mail</span>
                            Send Message (WhatsApp)
                        </a>

                        <!-- Email Button -->
                        <a href="mailto:@(Model.User?.Email)?subject=Car%20Inquiry:%20@Model.Car.Manufacturer%20@Model.Car.Model&body=Hello,%0D%0AI%20am%20interested%20in%20your%20car%20listing."
                           class="w-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-[#0d121b] dark:text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 mb-4">
                            <span class="material-symbols-outlined">mail</span>
                            Email Seller
                        </a>


                        <!-- Safety Tips -->
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                            <p class="text-sm text-blue-900 dark:text-blue-300 font-semibold mb-2">Safety Tips</p>
                            <ul class="text-xs text-blue-800 dark:text-blue-400 space-y-1">
                                <li>• Inspect vehicle thoroughly</li>
                                <li>• Meet in public location</li>
                                <li>• Check vehicle documents</li>
                                <li>• Test drive before buying</li>
                            </ul>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Owner Actions -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm sticky top-8 mb-6">
                        <h3 class="text-xl font-bold text-[#0d121b] dark:text-white mb-6">Listing Actions</h3>

                        <a href="@Url.Action("Edit", "Car", new { id = Model.ListingId })"
                           class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 mb-3">
                            <span class="material-symbols-outlined">edit</span>
                            Edit Listing
                        </a>

                        <form method="post" action="@Url.Action("Delete", "Car")">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.ListingId" />
                            <button type="submit"
                                    onclick="return confirm('Are you sure you want to delete this listing?');"
                                    class="w-full bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined">delete</span>
                                Delete Listing
                            </button>
                        </form>
                    </div>
                }

                <!-- Listing Info -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <h3 class="text-lg font-bold text-[#0d121b] dark:text-white mb-4">Listing Info</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Listing ID</span>
                            <span class="font-semibold text-[#0d121b] dark:text-white">#@Model.ListingId</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Type</span>
                            <span class="font-semibold text-[#0d121b] dark:text-white">
                                @(Model.Type == AutoHaven.Models.CarListingModel.ListingType.ForSelling ? "For Sale" : "For Rent")
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Status</span>
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold
                                @(Model.CurrentState == AutoHaven.Models.CarListingModel.State.Available ?
                                "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400" :
                                "bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400")">
                                @Model.CurrentState
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Posted</span>
                            <span class="font-semibold text-[#0d121b] dark:text-white">
                                @Model.CreatedAt.ToString("MMM dd, yyyy")
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
@if (User.Identity.IsAuthenticated)
{
    <div id="reviewModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full shadow-xl">
            <h2 class="text-xl font-bold text-[#0d121b] dark:text-white mb-4">Add Your Review</h2>

            <form id="reviewForm" method="POST" action="@Url.Action("AddReview", "Review")">
                @Html.AntiForgeryToken()
                <input type="hidden" name="listingId" value="@Model.ListingId" />

                <div class="mb-4">
                    <label class="block text-[#0d121b] dark:text-white font-semibold mb-2">Rating</label>
                    <div class="flex gap-2" id="ratingStars">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <button type="button" class="material-symbols-outlined text-3xl text-gray-300 cursor-pointer star-rating hover:text-yellow-400"
                                    data-rating="@i" onclick="setRating(@i)">
                                star
                            </button>
                        }
                    </div>
                    <input type="hidden" id="rating" name="rating" value="0" />
                </div>

                <div class="mb-4">
                    <label class="block text-[#0d121b] dark:text-white font-semibold mb-2">Comment</label>
                    <textarea name="comment" id="comment" rows="4"
                              class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm"
                              placeholder="Share your experience..." required></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="button" class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-700 text-[#0d121b] dark:text-white rounded-lg font-semibold hover:bg-gray-400 text-sm"
                            onclick="closeReviewModal()">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-blue-600 text-sm">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Initialize favorite button state
        document.addEventListener('DOMContentLoaded', function () {
            checkFavoriteStatus();
        });

        function changeMainImage(imagePath) {
            document.getElementById('mainImage').src = imagePath;
        }

        function checkFavoriteStatus() {
            const listingId = @Model.ListingId;
            fetch(`/Car/IsFavorite/${listingId}`)
                .then(r => r.json())
                .then(data => {
                    const btn = document.getElementById('favoriteBtn');
                    const text = document.getElementById('favBtnText');
                    if (data.isFavorite) {
                        btn.classList.add('bg-red-100', 'dark:bg-red-900/30', 'text-red-600', 'dark:text-red-400');
                        btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                        text.textContent = 'Favorited';
                    } else {
                        btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                        text.textContent = 'Add to Favorites';
                    }
                });
        }

        function toggleFavorite() {
            const btn = document.getElementById('favoriteBtn');
            const text = document.getElementById('favBtnText');
            const listingId = @Model.ListingId;

            fetch(`/Car/ToggleFavorite/${listingId}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.isFavorite) {
                        btn.classList.add('bg-red-100', 'dark:bg-red-900/30', 'text-red-600', 'dark:text-red-400');
                        btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                        text.textContent = 'Favorited';
                    } else {
                        btn.classList.remove('bg-red-100', 'dark:bg-red-900/30', 'text-red-600', 'dark:text-red-400');
                        btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                        text.textContent = 'Add to Favorites';
                    }
                });
        }

        function openReviewModal() {
            document.getElementById('reviewModal').classList.remove('hidden');
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
        }

        function setRating(rating) {
            document.getElementById('rating').value = rating;
            document.querySelectorAll('.star-rating').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-yellow-400');
                    star.classList.remove('text-gray-300');
                } else {
                    star.classList.remove('text-yellow-400');
                    star.classList.add('text-gray-300');
                }
            });
        }

        function deleteReview(reviewId, listingId) {
            if (confirm('Delete this review?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteReview", "Review")';
                form.innerHTML = `
        @Html.AntiForgeryToken()
                                    <input type="hidden" name="reviewId" value="${reviewId}" />
                                    <input type="hidden" name="listingId" value="${listingId}" />
                                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
    <script>
        function toggleEdit(id) {
            document.getElementById("edit-form-" + id).classList.toggle("hidden");
        }

        function deleteReview(reviewId, listingId) {
            if (confirm('Delete this review?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteReview", "Review")';
                form.innerHTML = `
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="reviewId" value="${reviewId}" />
                    <input type="hidden" name="listingId" value="${listingId}" />
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
                function setEditRating(reviewId, rating) {
            document.getElementById("edit-rating-" + reviewId).value = rating;
            const stars = document.querySelectorAll("#edit-stars-" + reviewId + " .star-edit");
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add("text-yellow-400");
                    star.classList.remove("text-gray-300");
                } else {
                    star.classList.remove("text-yellow-400");
                    star.classList.add("text-gray-300");
                }
            });
        }
    </script>
}