@model List<AutoHaven.Models.CarListingModel>

@{
    ViewBag.Title = "Find Your Next Vehicle - AutoHaven";
}

<main class="flex-grow w-full max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
        
        <!-- Filters Sidebar -->
        <aside class="w-full lg:w-1/4 xl:w-1/5 shrink-0">
            <form id="filterForm" method="get" action="@Url.Action("Index", "Car")">
                <div class="sticky top-28">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-[#0d121b] dark:text-white">Filters</h3>
                        <a href="@Url.Action("Index", "Car")" class="text-sm font-medium text-primary hover:underline">Reset</a>
                    </div>
                    
                    <!-- Listing Type Toggle -->
                    @{
                        int currentListingType = ViewBag.ListingType ?? 0;
                    }
                    <div class="flex bg-white dark:bg-card-dark p-1 rounded-lg border border-border-light dark:border-border-dark mb-4">
                        <label class="flex-1 text-sm font-semibold py-2 px-4 rounded-md text-center cursor-pointer"
                               style="background-color: @(currentListingType == 0 ? "#007BFF" : "transparent"); color: @(currentListingType == 0 ? "white" : "inherit");">
                            <input type="radio" name="listingType" value="0" class="hidden"/>
                            All
                        </label>
                        <label class="flex-1 text-sm font-semibold py-2 px-4 rounded-md text-center cursor-pointer"
                               style="background-color: @(currentListingType == 1 ? "#007BFF" : "transparent"); color: @(currentListingType == 1 ? "white" : "inherit");">
                            <input type="radio" name="listingType" value="1" class="hidden"/>
                            For Sale
                        </label>
                        <label class="flex-1 text-sm font-semibold py-2 px-4 rounded-md text-center cursor-pointer"
                               style="background-color: @(currentListingType == 2 ? "#007BFF" : "transparent"); color: @(currentListingType == 2 ? "white" : "inherit");">
                            <input type="radio" name="listingType" value="2" class="hidden"/>
                            For Rent
                        </label>
                    </div>
                    <script>
                        document.querySelector('input[name="listingType"][value="@currentListingType"]')?.checked = true;
                    </script>

                    <!-- Search -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-[#0d121b] dark:text-white mb-2">Search</label>
                        <input type="text" name="searchTerm" value="@ViewBag.SearchTerm" 
                               placeholder="Make, model, or description..." 
                               class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark text-[#0d121b] dark:text-white placeholder-text-secondary-light dark:placeholder-text-secondary-dark focus:outline-none focus:ring-2 focus:ring-primary"/>
                    </div>

                    <!-- Price Range -->
                    <details class="flex flex-col rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-card-dark px-[15px] py-[7px] group mb-4" open>
                        <summary class="flex cursor-pointer items-center justify-between gap-6 py-2 list-none">
                            <p class="text-sm font-medium text-[#0d121b] dark:text-white">Price Range</p>
                            <span class="material-symbols-outlined text-lg group-open:rotate-180 transition-transform">expand_more</span>
                        </summary>
                        <div class="pb-2 space-y-3">
                            <div>
                                <label class="text-sm text-[#4c669a] dark:text-gray-400">Min Price</label>
                                <input type="number" name="minPrice" value="@ViewBag.MinPrice" placeholder="Min" 
                                       class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark text-[#0d121b] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"/>
                            </div>
                            <div>
                                <label class="text-sm text-[#4c669a] dark:text-gray-400">Max Price</label>
                                <input type="number" name="maxPrice" value="@ViewBag.MaxPrice" placeholder="Max"
                                       class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark text-[#0d121b] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"/>
                            </div>
                        </div>
                    </details>

                    <!-- Make & Model -->
                    <details class="flex flex-col rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-card-dark px-[15px] py-[7px] group mb-4" open>
                        <summary class="flex cursor-pointer items-center justify-between gap-6 py-2 list-none">
                            <p class="text-sm font-medium text-[#0d121b] dark:text-white">Make</p>
                            <span class="material-symbols-outlined text-lg group-open:rotate-180 transition-transform">expand_more</span>
                        </summary>
                        <div class="pb-2 space-y-2 max-h-48 overflow-y-auto">
                            @{
                                var selectedMakes = ViewBag.SelectedMakes as string[] ?? new string[] { };
                            }
                            @foreach (var make in ViewBag.AvailableMakes)
                            {
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox"
                                           name="makes"
                                           value="@make"
                                    @(Array.Exists(selectedMakes, element => element == make) ? "checked" : "")
                                           class="w-4 h-4 rounded" />
                                    <span class="text-sm text-[#0d121b] dark:text-white">@make</span>
                                </label>
                            }
                        </div>
                    </details>

                    <!-- Year Range -->
                    <details class="flex flex-col rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-card-dark px-[15px] py-[7px] group mb-4">
                        <summary class="flex cursor-pointer items-center justify-between gap-6 py-2 list-none">
                            <p class="text-sm font-medium text-[#0d121b] dark:text-white">Year</p>
                            <span class="material-symbols-outlined text-lg group-open:rotate-180 transition-transform">expand_more</span>
                        </summary>
                        <div class="pb-2">
                            @{
                                int? selectedYear = ViewBag.SelectedYear;
                            }
                            <select name="selectedYear" id="yearSelect" class="w-full px-3 py-2 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-background-dark text-[#0d121b] dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">All Years</option>
                                @foreach (var year in ViewBag.Years)
                                {
                                    <option value="@year">@year</option>
                                }
                            </select>
                            @if (selectedYear.HasValue)
                            {
                                <script>
                                    document.getElementById('yearSelect').value = '@selectedYear';
                                </script>
                            }
                        </div>
                    </details>

                    <!-- Transmission -->
                    <details class="flex flex-col rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-card-dark px-[15px] py-[7px] group mb-4">
                        <summary class="flex cursor-pointer items-center justify-between gap-6 py-2 list-none">
                            <p class="text-sm font-medium text-[#0d121b] dark:text-white">Transmission</p>
                            <span class="material-symbols-outlined text-lg group-open:rotate-180 transition-transform">expand_more</span>
                        </summary>
                        <div class="pb-2 space-y-2">
                            @{
                                int? transmission = ViewBag.Transmission;
                            }
                            @foreach (var trans in ViewBag.Transmissions)
                            {
                                int transValue = (int)trans;
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="transmission" value="@transValue" class="w-4 h-4 rounded"/>
                                    <span class="text-sm text-[#0d121b] dark:text-white">@trans</span>
                                </label>
                            }
                            @if (transmission.HasValue)
                            {
                                <script>
                                    document.querySelector('input[name="transmission"][value="@transmission"]')?.checked = true;
                                </script>
                            }
                        </div>
                    </details>

                    <!-- Fuel Type -->
                    <details class="flex flex-col rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-card-dark px-[15px] py-[7px] group mb-4">
                        <summary class="flex cursor-pointer items-center justify-between gap-6 py-2 list-none">
                            <p class="text-sm font-medium text-[#0d121b] dark:text-white">Fuel Type</p>
                            <span class="material-symbols-outlined text-lg group-open:rotate-180 transition-transform">expand_more</span>
                        </summary>
                        <div class="pb-2 space-y-2">
                            @{
                                int? fuel = ViewBag.Fuel;
                            }
                            @foreach (var fuelType in ViewBag.Fuels)
                            {
                                int fuelValue = (int)fuelType;
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="fuel" value="@fuelValue" class="w-4 h-4 rounded"/>
                                    <span class="text-sm text-[#0d121b] dark:text-white">@fuelType</span>
                                </label>
                            }
                            @if (fuel.HasValue)
                            {
                                <script>
                                    document.querySelector('input[name="fuel"][value="@fuel"]')?.checked = true;
                                </script>
                            }
                        </div>
                    </details>

                    <!-- Apply Button -->
                    <button type="submit" class="w-full flex items-center justify-center overflow-hidden rounded-lg h-11 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-wide hover:bg-primary/90 transition-colors">
                        <span class="truncate">Apply Filters</span>
                    </button>
                </div>
            </form>
        </aside>

        <!-- Listings Area -->
        <section class="w-full lg:w-3/4 xl:w-3/5">
            <!-- Header -->
            <div class="flex flex-col min-w-72 gap-3 mb-6">
                <h1 class="text-3xl lg:text-4xl font-black tracking-tighter text-[#0d121b] dark:text-white">Find Your Next Vehicle</h1>
                <p class="text-base font-normal text-[#4c669a] dark:text-gray-400">Explore thousands of vehicles from certified dealers and private sellers.</p>
            </div>

            <!-- Sort and View Options -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-6 p-4 bg-white dark:bg-card-dark rounded-lg border border-border-light dark:border-border-dark">
                <p class="text-sm font-medium text-[#4c669a] dark:text-gray-400">
                    Showing <span class="font-bold text-[#0d121b] dark:text-white">@Model.Count</span> of 
                    <span class="font-bold text-[#0d121b] dark:text-white">@ViewBag.TotalCount</span> results
                </p>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-[#0d121b] dark:text-white">Sort by:</span>
                        <form method="get" action="@Url.Action("Index", "Car")" style="display: inline;">
                            <input type="hidden" name="searchTerm" value="@ViewBag.SearchTerm"/>
                            <input type="hidden" name="minPrice" value="@ViewBag.MinPrice"/>
                            <input type="hidden" name="maxPrice" value="@ViewBag.MaxPrice"/>
                            <input type="hidden" name="selectedYear" value="@ViewBag.SelectedYear"/>
                            <input type="hidden" name="transmission" value="@ViewBag.Transmission"/>
                            <input type="hidden" name="fuel" value="@ViewBag.Fuel"/>
                            <input type="hidden" name="listingType" value="@ViewBag.ListingType"/>
                            
                            @{
                                string currentSort = ViewBag.SortBy ?? "newest";
                            }
                            
                            <select name="sortBy" id="sortBySelect" onchange="this.form.submit();" 
                                    class="form-select text-sm rounded-lg border-border-light dark:border-border-dark bg-white dark:bg-background-dark text-[#0d121b] dark:text-white focus:ring-primary focus:border-primary">
                                <option value="newest">Newest Listed</option>
                                <option value="price_asc">Price (Low to High)</option>
                                <option value="price_desc">Price (High to Low)</option>
                                <option value="highest_rated">Highest Rated</option>
                                <option value="most_viewed">Most Viewed</option>
                            </select>
                            
                            <script>
                                document.getElementById('sortBySelect').value = '@currentSort';
                            </script>
                        </form>
                    </div>
                </div>
            </div>

            @if (!Model.Any())
            {
                <div class="text-center py-12">
                    <span class="material-symbols-outlined text-6xl text-[#4c669a] dark:text-gray-400 mb-4 block">search_off</span>
                    <p class="text-lg font-semibold text-[#0d121b] dark:text-white">No listings found</p>
                    <p class="text-sm text-[#4c669a] dark:text-gray-400">Try adjusting your filters or search term</p>
                </div>
            }
            else
            {
                <!-- Car Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
    @foreach (var listing in Model)
    {
        decimal price = listing.Type == AutoHaven.Models.CarListingModel.ListingType.ForSelling ? listing.NewPrice : listing.RentPrice;
        string priceLabel = listing.Type == AutoHaven.Models.CarListingModel.ListingType.ForSelling ? "Sale" : "Per Day";

        <!-- ✅ GET AVERAGE RATING -->
        
            var reviews = ViewBag.Reviews as List<AutoHaven.Models.ReviewModel> ?? new List<AutoHaven.Models.ReviewModel>();
            var listingReviews = reviews.Where(r => r.ListingId == listing.ListingId).ToList();
            double avgRating = listingReviews.Any() ? listingReviews.Average(r => r.Rating) : 0;
            int reviewCount = listingReviews.Count();
        

        <div class="flex flex-col bg-white dark:bg-card-dark rounded-xl shadow-sm overflow-hidden border border-border-light dark:border-border-dark group transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
            <!-- Image -->
            <div class="relative overflow-hidden bg-background-light dark:bg-background-dark h-48">
                @if (listing.CarImages != null && listing.CarImages.Any())
                {
                    <img class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" 
                         src="/@listing.CarImages.First().Path" alt="@listing.Car.Manufacturer @listing.Car.Model"/>
                }
                else
                {
                    <div class="w-full h-full flex items-center justify-center text-gray-400">
                        <span class="material-symbols-outlined !text-6xl">directions_car</span>
                    </div>
                }

                <!-- Badge -->
                @if (listing.IsFeatured)
                {
                    <div class="absolute bottom-3 left-3 bg-primary/80 backdrop-blur-sm text-white text-xs font-bold px-2 py-1 rounded-full">Featured</div>
                }
            </div>

            <!-- Content -->
            <div class="p-4 flex flex-col flex-grow">
                <h3 class="text-lg font-bold text-[#0d121b] dark:text-white mb-1">
                    @listing.Car.ModelYear @listing.Car.Manufacturer @listing.Car.Model
                </h3>
                <p class="text-sm text-[#4c669a] dark:text-gray-400 mb-3">
                    @listing.Car.CurrentTransmission • @listing.Car.CurrentFuel
                </p>

                <!-- ✅ AVERAGE RATING DISPLAY -->
                <div class="flex items-center gap-2 mb-3">
                    <div class="flex gap-0.5">
                        @for (int i = 1; i <= 5; i++)
                        {
                            @if (i <= Math.Floor(avgRating))
                            {
                                <span class="material-symbols-outlined text-yellow-400 text-xs">star</span>
                            }
                            else
                            {
                                <span class="material-symbols-outlined text-gray-300 text-xs">star</span>
                            }
                        }
                    </div>
                    <span class="text-xs font-semibold text-[#0d121b] dark:text-white">@avgRating.ToString("F1")</span>
                    <span class="text-xs text-[#4c669a] dark:text-gray-400">(@reviewCount)</span>
                </div>

                <!-- Price and Details -->
                <div class="mt-auto flex justify-between items-center">
                    <div>
                        <p class="text-xl font-black text-primary">$@price.ToString("N0")</p>
                        <p class="text-xs text-[#4c669a] dark:text-gray-400">@priceLabel</p>
                    </div>
                    <a href="@Url.Action("Details", "Car", new { id = listing.ListingId })" 
                       class="text-sm font-bold text-primary hover:underline">Details</a>
                </div>
            </div>
        </div>
    }
</div>

                <!-- Pagination -->
                @if (ViewBag.TotalPages > 1)
                {
                    <nav aria-label="Pagination" class="flex items-center justify-center gap-2">
                        @if (ViewBag.CurrentPage > 1)
                        {
                            <a href="@Url.Action("Index", "Car", new {
                page = ViewBag.CurrentPage - 1,
                searchTerm = ViewBag.SearchTerm,
                minPrice = ViewBag.MinPrice,
                maxPrice = ViewBag.MaxPrice,
                selectedYear = ViewBag.SelectedYear,
                transmission = ViewBag.Transmission,
                fuel = ViewBag.Fuel,
                listingType = ViewBag.ListingType,
                sortBy = ViewBag.SortBy,
                makes = string.Join("&makes=", ViewBag.SelectedMakes ?? new string[] { })  // ✅ ADD THIS
            })" class="p-2 rounded-lg border border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark">
                                <span class="material-symbols-outlined">chevron_left</span>
                            </a>
                        }

                        @for (int i = 1; i <= ViewBag.TotalPages; i++)
                        {
                            @if (i == ViewBag.CurrentPage)
                            {
                                <button class="px-4 py-2 rounded-lg bg-primary text-white font-semibold">@i</button>
                            }
                            else if (i <= 3 || i >= ViewBag.TotalPages - 2 || (i >= ViewBag.CurrentPage - 1 && i <= ViewBag.CurrentPage + 1))
                            {
                                <a href="@Url.Action("Index", "Car", new {
                    page = i,
                    searchTerm = ViewBag.SearchTerm,
                    minPrice = ViewBag.MinPrice,
                    maxPrice = ViewBag.MaxPrice,
                    selectedYear = ViewBag.SelectedYear,
                    transmission = ViewBag.Transmission,
                    fuel = ViewBag.Fuel,
                    listingType = ViewBag.ListingType,
                    sortBy = ViewBag.SortBy,
                    makes = string.Join("&makes=", ViewBag.SelectedMakes ?? new string[] { })  
                })" class="px-4 py-2 rounded-lg border border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark text-[#0d121b] dark:text-white">@i</a>
                            }
                            else if (i == 4 || i == ViewBag.TotalPages - 3)
                            {
                                <span class="px-2 text-[#4c669a] dark:text-gray-400">...</span>
                            }
                        }

                        @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                        {
                            <a href="@Url.Action("Index", "Car", new {
                page = ViewBag.CurrentPage + 1,
                searchTerm = ViewBag.SearchTerm,
                minPrice = ViewBag.MinPrice,
                maxPrice = ViewBag.MaxPrice,
                selectedYear = ViewBag.SelectedYear,
                transmission = ViewBag.Transmission,
                fuel = ViewBag.Fuel,
                listingType = ViewBag.ListingType,
                sortBy = ViewBag.SortBy,
                makes = string.Join("&makes=", ViewBag.SelectedMakes ?? new string[] { })  
            })" class="p-2 rounded-lg border border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark">
                                <span class="material-symbols-outlined">chevron_right</span>
                            </a>
                        }
                    </nav>
                }
            }
        </section>
    </div>
</main>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ===== LISTING TYPE TOGGLE =====
            document.querySelectorAll('input[name="listingType"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    document.getElementById('filterForm').submit();
                });
            });
        });
    </script>
}